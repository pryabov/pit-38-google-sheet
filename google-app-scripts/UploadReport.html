<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    /* Style for the loading indicator */
    #loadingIndicator {
      display: none; /* Initially hidden */
      margin-top: 10px;
      font-weight: bold;
    }
    /* Style for the error message */
    #errorMessage {
      display: none; /* Initially hidden */
      margin-top: 10px;
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <form id="fileForm">
    <input type="file" id="fileInput" accept=".csv">
    <input type="button" id="uploadButton" value="Upload" onclick="uploadFile()">
  </form>
  <div id="loadingIndicator">Loading, please wait...</div>
  <div id="errorMessage"></div>
  <script>
    function uploadFile() {
      var fileInput = document.getElementById('fileInput');
      var uploadButton = document.getElementById('uploadButton');
      var loadingIndicator = document.getElementById('loadingIndicator');
      var errorMessage = document.getElementById('errorMessage');
      var file = fileInput.files[0];
      if (file) {
        // Clear any previous error messages
        errorMessage.style.display = 'none';
        errorMessage.textContent = '';
        // Show the loading indicator
        loadingIndicator.style.display = 'block';
        // Disable the form elements
        fileInput.disabled = true;
        uploadButton.disabled = true;

        var reader = new FileReader();
        reader.onload = function(event) {
          var base64Data = event.target.result.split(',')[1]; // Extract the base64 part
          var fileName = file.name;
          // Send the base64 data and file name to the server-side script
          google.script.run
            .withSuccessHandler(onSuccess)
            .withFailureHandler(onFailure)
            .processFile(fileName, base64Data);
        };
        // Read the file as a data URL
        reader.readAsDataURL(file);
      } else {
        console.error("No file selected");
        errorMessage.style.display = 'block';
        errorMessage.textContent = 'Please select a file to upload.';
      }
    }

    function onSuccess(message) {
      document.getElementById('loadingIndicator').style.display = 'none';
      if (message) {
        var msgDiv = document.getElementById('errorMessage');
        msgDiv.style.display = 'block';
        msgDiv.style.color = 'green';
        msgDiv.textContent = message;
        setTimeout(function() { google.script.host.close(); }, 2000);
      } else {
        google.script.host.close();
      }
    }

    function onFailure(error) {
      document.getElementById('loadingIndicator').style.display = 'none';
      // Re-enable form elements
      document.getElementById('fileInput').disabled = false;
      document.getElementById('uploadButton').disabled = false;
      var msgDiv = document.getElementById('errorMessage');
      msgDiv.style.display = 'block';
      msgDiv.style.color = 'red';
      msgDiv.textContent = error.message || 'There was an error processing your file. Please try again.';
    }
  </script>
</body>
</html>